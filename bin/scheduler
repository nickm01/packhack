#!/usr/bin/env node

var config = require('../config');
var twilio = require('twilio')(config.accountSid, config.authToken);
var MongoClient = require('mongodb').MongoClient;
var mongoOp = require("./model/mongo");
var sendSms = require('./sendsms');

function processScheduler() {

  mongoOp.ListItems.find({'listKey':listName, 'familyId': familyId}, function(err, listItems){
    if(err){
      logError(fromPhoneNumber, familyId, bodyText, err);
              } else {
                var concatText = "";
                var itemNumber = 0;
                listItems.forEach(function(listItem){
                  itemNumber++;
                  concatText = concatText.concat('\nâ€¢ ' + listItem.listItemName);
                });
                if (itemNumber == 0) {
                  concatText = concatText.concat('No items in #' + listName + '.');
                }
                cacheListName(listName,res);
                sendSMSResponse(fromPhoneNumber, familyId, bodyText, '\n#'+ listName + ':' + concatText, res);
             }
            });
  sendSms.sendSms("+13476979750", "from scheduler!", function(){
  	process.exit();
  });
}

processScheduler();

/*
function sendSms(to, message) {
  twilio.messages.create({
    body: message,
    to: to,
    from: config.sendingNumber
  }, function(err, data) {
    if (err) {
      console.error('Could not send message');
      console.error(err);
    } else {
      console.error('SMS');
    }
    process.exit();
  });
};
*/

