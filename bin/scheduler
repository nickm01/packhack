#!/usr/bin/env node

var config = require('../config')
var mongoOp = require('../model/mongo')
var sendSms = require('../sendsms')
var logging = require('../logging')
var listItemFunctions = require('../listitems')

var count = 0

function processScheduler () {
  mongoOp.ListItems.find({'listKey': config.remindersListKey}, function (err, listItems) {
    if (err) {
      logging.logError('scheduler', '', '', err)
    } else {
      listItems.forEach(function (listItem) {
        var familyId = listItem.familyId
        var reminderDate = new Date(listItem.reminderWhen)
        var now = new Date()
        console.log('now: ' + now)
        console.log('Scheduler2:' + reminderDate + ' userId:' + listItem.reminderUserId + ' listItemName:' + listItem.listItemName)

        if (reminderDate < now) {
          // Remove listItem first
          listItemFunctions.deleteListItemByName(familyId, listItem.listKey, listItem.listItemName, function (err) {
            if (err) {
              return
            } else {
              // Send to single or multiple family members
              multipleOrSingleFamilyMembersForReminderUserId(familyId, listItem.reminderUserId, function (err, familyMember) {
                if (err) {
                  logging.logError('0', familyId, listItem, err)
                  return
                }
                count++ // TODO: Use Q here this is awful
                textForReminder(listItem, function (err, text) {
                  if (err) {
                  }
                  console.log('Count++ ' + count + ' pn:' + familyMember.phoneNumber + ' ' + familyMember.name)
                  logging.log(familyMember.phoneNumber, familyId, text, 'Reminder', '')
                  sendSms.sendSms(familyMember.phoneNumber, text, function () {
                    count--
                    console.log('Count-- ' + count)
                    if (count === 0) {
                      process.exit()
                    }
                  })
                })
              })
            }
          })
        }
      })
    }
  })
}

function multipleOrSingleFamilyMembersForReminderUserId (familyId, reminderUserId, callback) {
  console.log('FAM ID:' + familyId + ' UserId:' + reminderUserId)
  if (reminderUserId !== config.allFamilyMembersID) {
    mongoOp.FamilyMembers.findOne({'familyId': familyId, 'userId': reminderUserId}, function (err, familyMember) {
      console.log('FAM-SINGLE pn:' + familyMember.phoneNumber + ' ' + familyMember.name)
      callback(err, familyMember)
    })
  } else {
    mongoOp.FamilyMembers.find({'familyId': familyId}, function (err, familyMembers) {
      if (err) {
        callback(err)
      } else {
        familyMembers.forEach(function (familyMember) {
          console.log('FAM-MUTLI pn:' + familyMember.phoneNumber + ' ' + familyMember.name)
          callback(null, familyMember)
        })
      }
    })
  }
}

function textForReminder (listItem, callback) {
  if (listItem.reminderListKey == null || listItem.reminderListKey === '') {
    callback(null, '⏰ ' + listItem.reminderTitle)
  } else {
    var unconfirmedList = {'listKey': listItem.reminderListKey, 'familyId': listItem.familyId}
    listItemFunctions.listItemsTextForList(unconfirmedList, function (err, text) {
      console.log('****TEST24:' + err + ':' + text)
      if (err) {
        callback(err)
      } else {
        console.log('****TEST25:' + listItem.reminderTitle + ':' + listItem.reminderListKey)
        var reminderText = ''
        if (text === '' && listItem.reminderTitle === '') {
          console.log('****TEST20')
          reminderText = '⏰ #' + listItem.reminderListKey + ' - currently empty.'
        } else if (text === '' && listItem.reminderTitle !== '') {
          console.log('****TEST21')
          reminderText = '⏰ ' + listItem.reminderTitle + '\n(#' + listItem.reminderListKey + ' is currently empty.)'
        } else if (text !== '' && listItem.reminderTitle === '') {
          console.log('****TEST22')
          reminderText = '⏰ #' + listItem.reminderListKey + ':' + text
        } else if (text !== '' && listItem.reminderTitle !== '') {
          console.log('****TEST23')
          reminderText = '⏰ ' + listItem.reminderTitle + ':\n#' + listItem.reminderListKey + text
        }
        console.log('****TEST26:' + reminderText)
        callback(null, reminderText)
      }
    })
  }
}

processScheduler()
